name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            rid: linux-x64
            artifact_name: linux
            asset_name: Linux
          - os: windows-latest
            rid: win-x64
            artifact_name: windows
            asset_name: Windows
          - os: macos-latest
            rid: osx-arm64
            artifact_name: macos
            asset_name: Mac

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Get Version
        id: get_version
        shell: bash
        run: |
          # Strip 'v' prefix if present for dotnet versioning compatibility
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          CLEAN_VERSION="${TAG_NAME#v}"
          echo "VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Restore dependencies
        run: dotnet restore RegistrationEasy/RegistrationEasy.Desktop.csproj

      - name: Publish
        shell: bash
        run: |
          dotnet publish RegistrationEasy/RegistrationEasy.Desktop.csproj \
          -c Release \
          -r ${{ matrix.rid }} \
          --self-contained true \
          -p:PublishSingleFile=true \
          -p:Version=${{ steps.get_version.outputs.VERSION }} \
          -o publish

      - name: Rename and Zip
        shell: bash
        run: |
          cd publish
          # Create zip file with format: AppName-Arch-Version.zip
          # Example: RegistrationEasy-linux-x64-v1.0.0.zip

          ZIP_NAME="RegistrationEasy-${{ matrix.rid }}-${{ steps.get_version.outputs.TAG_NAME }}.zip"
          LATEST_ZIP_NAME="RegistrationEasy-${{ matrix.rid }}-latest.zip"

          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            7z a -tzip "../$ZIP_NAME" *
          else
            zip -r "../$ZIP_NAME" .
          fi

          # Create a copy with 'latest' name
          cp "../$ZIP_NAME" "../$LATEST_ZIP_NAME"

          echo "ASSET_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ./*.zip

  android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: microsoft
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3.0.0
        with:
          packages: |
            platform-tools
            platforms;android-34
            build-tools;34.0.0

      - name: Install .NET Android workload
        run: dotnet workload install android --ignore-failed-sources --source https://api.nuget.org/v3/index.json

      - name: Get Version
        id: get_version
        shell: bash
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          CLEAN_VERSION="${TAG_NAME#v}"
          echo "VERSION=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Decode Android keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p RegistrationEasy.Android
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > RegistrationEasy.Android/ci-release.keystore

      - name: Publish signed Android APK
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          dotnet publish RegistrationEasy.Android/RegistrationEasy.Android.csproj \
            -c Release \
            -f net10.0-android \
            -p:AndroidKeyStore=true \
            -p:AndroidSigningKeyStore=ci-release.keystore \
            -p:AndroidSigningStorePass=$ANDROID_KEYSTORE_PASSWORD \
            -p:AndroidSigningKeyAlias=$ANDROID_KEY_ALIAS \
            -p:AndroidSigningKeyPass=$ANDROID_KEY_PASSWORD

      - name: Locate and rename APK
        shell: bash
        run: |
          APK_PATH=$(find RegistrationEasy.Android/bin/Release -name "*-Signed.apk" | head -n 1)
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find RegistrationEasy.Android/bin/Release -name "*.apk" | head -n 1)
          fi
          if [ -z "$APK_PATH" ]; then
            echo "No APK found" >&2
            exit 1
          fi
          APK_NAME="RegistrationEasy-Android-${{ steps.get_version.outputs.TAG_NAME }}.apk"
          LATEST_APK_NAME="RegistrationEasy-Android-latest.apk"
          cp "$APK_PATH" "$APK_NAME"
          cp "$APK_PATH" "$LATEST_APK_NAME"

      - name: Upload Android Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: ./*.apk

  release:
    needs:
      - build
      - android
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4

      - name: Display structure of downloaded files
        run: ls -R

      # 1. Create the normal versioned release (e.g. v1.0.0)
      # This preserves history and includes versioned assets
      - name: Create Versioned Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          files: |
            linux/*-v*.zip
            windows/*-v*.zip
            macos/*-v*.zip
            android/*-v*.apk
          generate_release_notes: true
          draft: false
          prerelease: false

      # 2. Update the 'latest' release
      # This ensures a fixed URL for the latest assets
      - name: Update Latest Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing 'latest' release and tag if they exist
          gh release delete latest --cleanup-tag -y || true

          # Create new 'latest' release pointing to the current commit
          # using the 'latest' artifacts
          gh release create latest \
            --title "Latest Release" \
            --notes "Always updated to the latest build artifacts. Current version: ${{ github.ref_name }}" \
            --prerelease=false \
            --target ${{ github.sha }} \
            linux/*-latest.zip \
            windows/*-latest.zip \
            macos/*-latest.zip \
            android/*-latest.apk
